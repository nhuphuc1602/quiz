<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>App Trắc Nghiệm Luật Viên Chức</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  max-width: 900px;
  margin: 40px auto;
  padding: 20px 30px 40px 30px;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  color: #333;
}

h1 {
  text-align: center;
  font-weight: 700;
  font-size: 2.8rem;
  color: #1a237e;
  margin-bottom: 40px;
  text-shadow: 0 2px 5px rgba(26, 35, 126, 0.3);
  user-select: none;
}

#controls {
  text-align: center;
  margin-bottom: 25px;
}

#num-questions {
  width: 70px;
  font-size: 1.1rem;
  padding: 7px 12px;
  border-radius: 8px;
  border: 1.8px solid #b0bec5;
  transition: border-color 0.3s ease;
}

#num-questions:focus {
  outline: none;
  border-color: #3949ab;
  box-shadow: 0 0 8px rgba(57, 73, 171, 0.5);
}

.btn {
  padding: 12px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  margin: 0 8px 12px 8px;
  border-radius: 12px;
  border: none;
  color: white;
  background: #3949ab;
  box-shadow: 0 4px 15px rgba(57, 73, 171, 0.4);
  transition: background-color 0.25s ease, box-shadow 0.25s ease;
  user-select: none;
}

.btn:hover:not(:disabled) {
  background: #283593;
  box-shadow: 0 6px 20px rgba(40, 53, 147, 0.6);
}

.btn:disabled {
  background: #9fa8da;
  cursor: not-allowed;
  box-shadow: none;
}

#quiz-form {
  user-select: none;
}

.question {
  margin-bottom: 25px;
  padding: 22px 26px;
  background: white;
  border-radius: 18px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  border: 3px solid transparent;
  transition: background-color 0.35s ease, border-color 0.35s ease;
}

.question p {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 16px;
  color: #22254b;
  user-select: text;
}

.options label {
  display: block;
  margin-bottom: 12px;
  cursor: pointer;
  font-size: 1.05rem;
  padding: 10px 18px;
  border-radius: 12px;
  border: 2px solid transparent;
  transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
  user-select: text;
  color: #3e424e;
}

.options label:hover {
  background-color: #e8eaf6;
  border-color: #3949ab;
  color: #1a237e;
}

.options input[type="radio"] {
  margin-right: 14px;
  transform: scale(1.3);
  cursor: pointer;
  vertical-align: middle;
}

.result-icon {
  font-weight: 900;
  margin-left: 14px;
  font-size: 1.5rem;
  vertical-align: middle;
  user-select: none;
}

#result {
  margin-top: 35px;
  font-size: 1.5rem;
  font-weight: 700;
  text-align: center;
  color: #1a237e;
  text-shadow: 1px 1px 2px rgba(57, 73, 171, 0.3);
  user-select: none;
}

</style>
</head>
<body>

<h1>Trắc Nghiệm Luật Viên Chức</h1>

<div id="controls">
  <button id="load-btn" class="btn">Tải câu hỏi</button>
  <label for="num-questions">Số câu random:</label>
  <input type="number" id="num-questions" min="1" max="1000" value="60" />
  <button id="random-btn" class="btn" disabled>Random lại</button>
  <button id="submit-btn" class="btn" disabled>Nộp bài</button>
</div>

<form id="quiz-form"></form>
<div id="result"></div>

<script>
let allQuestions = [];
let currentQuestions = [];

// Hàm lấy n câu random từ mảng
function getRandomQuestions(arr, n) {
  const shuffled = arr.slice().sort(() => 0.5 - Math.random());
  return shuffled.slice(0, n);
}

// Tìm đáp án đúng (có **...**)
function findCorrectOption(question) {
  for (const [key, val] of Object.entries(question.options)) {
    if (val.includes('**')) return key;
  }
  return null;
}

// Hiển thị quiz
function renderQuiz(questions) {
  const form = document.getElementById('quiz-form');
  form.innerHTML = '';
  questions.forEach((q, idx) => {
    const qDiv = document.createElement('div');
    qDiv.className = 'question';
    qDiv.innerHTML = `<p><strong>Câu ${idx+1}:</strong> ${q.question_text}</p>`;
    const optionsDiv = document.createElement('div');
    optionsDiv.className = 'options';

    for (const [key, val] of Object.entries(q.options)) {
      const cleanVal = val.replace(/\*\*/g, '').trim();
      const inputId = `q${idx}_${key}`;
      const label = document.createElement('label');
      label.htmlFor = inputId;
      label.innerHTML = `<input type="radio" name="q${idx}" id="${inputId}" value="${key}"> (${key}) ${cleanVal}`;
      optionsDiv.appendChild(label);
    }

    qDiv.appendChild(optionsDiv);
    form.appendChild(qDiv);
  });
}

// Chấm điểm và highlight đúng sai
function gradeQuiz(questions) {
  let score = 0;
  const form = document.getElementById('quiz-form');
  questions.forEach((q, idx) => {
    const correctKey = findCorrectOption(q);
    const selected = form.querySelector(`input[name=q${idx}]:checked`);
    const qDiv = form.children[idx];
    
    // Reset trạng thái trước khi highlight
    qDiv.style.backgroundColor = 'white';
    qDiv.style.borderColor = 'transparent';
    // Xóa icon cũ nếu có
    const oldIcon = qDiv.querySelector('.result-icon');
    if (oldIcon) oldIcon.remove();

    if (selected && selected.value === correctKey) {
      score++;
      qDiv.style.backgroundColor = '#d4edda'; // xanh nhạt
      qDiv.style.borderColor = '#28a745';
      const icon = document.createElement('span');
      icon.className = 'result-icon';
      icon.style.color = '#28a745';
      icon.textContent = '✔';
      qDiv.querySelector('p').appendChild(icon);
    } else {
      qDiv.style.backgroundColor = '#f8d7da'; // đỏ nhạt
      qDiv.style.borderColor = '#dc3545';
      const icon = document.createElement('span');
      icon.className = 'result-icon';
      icon.style.color = '#dc3545';
      icon.textContent = '✘';
      qDiv.querySelector('p').appendChild(icon);
    }
  });
  return score;
}

function showResult(score, total) {
  const resultDiv = document.getElementById('result');
  resultDiv.textContent = `Bạn làm đúng ${score} trên ${total} câu hỏi. Điểm: ${(score/total*10).toFixed(2)} / 10`;
}

// Load file JSON từ path cố định
document.getElementById('load-btn').addEventListener('click', () => {
  fetch('questions.json')
    .then(resp => {
      if (!resp.ok) throw new Error('Không thể tải file questions.json');
      return resp.json();
    })
    .then(data => {
      if (!Array.isArray(data)) throw new Error('File JSON phải là mảng câu hỏi');
      allQuestions = data;
      const n = parseInt(document.getElementById('num-questions').value) || 60;
      currentQuestions = getRandomQuestions(allQuestions, Math.min(n, allQuestions.length));
      renderQuiz(currentQuestions);
      document.getElementById('submit-btn').disabled = false;
      document.getElementById('random-btn').disabled = false;
      document.getElementById('result').textContent = '';
    })
    .catch(err => alert('Lỗi: ' + err.message));
});

// Random lại với số câu theo input
document.getElementById('random-btn').addEventListener('click', () => {
  if (allQuestions.length === 0) return alert('Chưa tải câu hỏi nào!');
  const n = parseInt(document.getElementById('num-questions').value);
  if (isNaN(n) || n < 1) return alert('Vui lòng nhập số câu hợp lệ (tối thiểu 1).');
  currentQuestions = getRandomQuestions(allQuestions, Math.min(n, allQuestions.length));
  renderQuiz(currentQuestions);
  document.getElementById('result').textContent = '';
});

// Nộp bài
document.getElementById('submit-btn').addEventListener('click', () => {
  if (currentQuestions.length === 0) return alert('Chưa có câu hỏi để chấm!');
  const score = gradeQuiz(currentQuestions);
  showResult(score, currentQuestions.length);
  window.scrollTo(0, document.body.scrollHeight);
});
</script>

</body>
</html>
